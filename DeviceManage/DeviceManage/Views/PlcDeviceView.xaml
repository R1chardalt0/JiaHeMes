<UserControl x:Class="DeviceManage.Views.PlcDeviceView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:DeviceManage.Views"
      xmlns:vm="clr-namespace:DeviceManage.ViewModels"
      xmlns:vms="clr-namespace:DeviceManage.ViewModels"
      xmlns:hc="https://handyorg.github.io/handycontrol"
      mc:Ignorable="d"
      d:DesignHeight="600" d:DesignWidth="1000">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Resources/Converters.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

            <!-- 现代按钮样式 -->
            <Style x:Key="ModernButton" TargetType="Button">
                <Setter Property="Background" Value="{StaticResource PrimaryBrush}"/>
                <Setter Property="Foreground" Value="White"/>
                <Setter Property="Padding" Value="12,8"/>
                <Setter Property="FontSize" Value="13"/>
                <Setter Property="FontWeight" Value="Medium"/>
                <Setter Property="Cursor" Value="Hand"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="Margin" Value="0,0,15,0"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}"
                                    CornerRadius="6"
                                    Padding="{TemplateBinding Padding}">
                                <ContentPresenter HorizontalAlignment="Center" 
                                                VerticalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
                <Style.Triggers>
                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter Property="Opacity" Value="0.9"/>
                    </Trigger>
                    <Trigger Property="IsPressed" Value="True">
                        <Setter Property="Opacity" Value="0.8"/>
                    </Trigger>
                </Style.Triggers>
            </Style>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Toast消息容器 -->
        <Canvas x:Name="ToastContainer" Grid.RowSpan="3" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Panel.ZIndex="1000"/>

        <!-- 顶部按钮区域：保留刷新和新增 -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
            <Button Content="刷新" 
                    Command="{Binding LoadPlcDevicesCommand}"                
                    Margin="0,0,15,0"
                    Style="{StaticResource ButtonDashedInfo}"/>
            <Button Content="新增" 
                    Command="{Binding AddPlcDeviceCommand}"
                    Margin="0,0,15,0"
                    Style="{StaticResource ButtonDashedSuccess}"/>
        </StackPanel>

        <!-- 数据表格区域 -->
        <DataGrid Grid.Row="1" 
                  ItemsSource="{Binding PlcDevices.Value}"
                  SelectedItem="{Binding SelectedPlcDevice.Value, Mode=TwoWay}"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  IsReadOnly="True"
                  HeadersVisibility="Column"
                  GridLinesVisibility="None"
                  BorderThickness="1"
                  BorderBrush="#DDDDDD">
            <DataGrid.Columns>
                <DataGridTextColumn Header="ID" 
                                    Binding="{Binding Id}" 
                                    Width="80"
                                  />
                <DataGridTextColumn Header="PLC名称" 
                                    Binding="{Binding PLCName}" 
                                    Width="*"
                                  />
                <DataGridTextColumn Header="IP地址" 
                                    Binding="{Binding IPAddress}" 
                                    Width="*"
                                    />
                <DataGridTextColumn Header="端口号" 
                                    Binding="{Binding Port}" 
                                    Width="80"
                                    />
                <DataGridTextColumn Header="通信协议" 
                                    Binding="{Binding Protocolc}" 
                                    Width="*"
                                    />
                <DataGridTextColumn Header="型号" 
                                    Binding="{Binding Model}" 
                                    Width="*"
                                    />
                <DataGridTextColumn Header="描述" 
                                    Binding="{Binding Remarks}" 
                                    Width="*"/>

                <!-- 操作列：编辑 / 删除 -->
                <DataGridTemplateColumn Header="操作" Width="160">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <Button Content="编辑"
                                        Margin="0,0,10,0"
                                        Style="{StaticResource ButtonDashedSuccess}"
                                        Command="{Binding DataContext.EditCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding}"/>
                                <Button Content="删除"
                                        Style="{StaticResource ButtonDashedDanger}"
                                        Command="{Binding DataContext.DeletePlcDeviceCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding}"/>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <!-- 弹出框：用于新增 / 编辑 PLC 设备 -->
        <Border Grid.RowSpan="2"
                Background="#80000000"
                Visibility="{Binding IsDialogOpen.Value, Converter={StaticResource BooleanToVisibilityConverter}}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <Border HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Width="600"
                    Background="White"
                    CornerRadius="8"
                    Padding="20">
                <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- 标题：根据 IsEditing 显示不同文字 -->
                <Grid Grid.Row="0" Margin="0,0,0,10">
                    <TextBlock FontSize="16" FontWeight="Bold">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Text" Value="新增PLC设备"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsEditing.Value}" Value="True">
                                        <Setter Property="Text" Value="编辑PLC设备"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </Grid>

                <Grid Grid.Row="1" Margin="0,10,0,10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,10,10">
                        <Label Content="PLC名称:" FontSize="12" Margin="0,0,0,5"/>
                        <TextBox Text="{Binding EditingPlcDevice.Value.PLCName, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"/>
                    </StackPanel>

                    <StackPanel Grid.Row="0" Grid.Column="1" Margin="0,0,0,10">
                        <Label Content="IP地址:" FontSize="12" Margin="0,0,0,5"/>
                        <TextBox Text="{Binding EditingPlcDevice.Value.IPAddress, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"/>
                    </StackPanel>

                    <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,10,10">
                        <Label Content="端口号:" FontSize="12" Margin="0,0,0,5"/>
                        <TextBox Text="{Binding EditingPlcDevice.Value.Port, UpdateSourceTrigger=LostFocus, Mode=TwoWay}"/>
                    </StackPanel>

                    <StackPanel Grid.Row="1" Grid.Column="1" Margin="0,0,0,10">
                        <Label Content="通信协议:" FontSize="12" Margin="0,0,0,5"/>
                        <TextBox Text="{Binding EditingPlcDevice.Value.Protocolc, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"/>
                    </StackPanel>

                    <StackPanel Grid.Row="2" Grid.Column="0" Margin="0,0,10,0">
                        <Label Content="型号:" FontSize="12" Margin="0,0,0,5"/>
                        <TextBox Text="{Binding EditingPlcDevice.Value.Model, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"/>
                    </StackPanel>

                    <StackPanel Grid.Row="2" Grid.Column="1">
                        <Label Content="描述:" FontSize="12" Margin="0,0,0,5"/>
                        <TextBox Text="{Binding EditingPlcDevice.Value.Remarks, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"/>
                    </StackPanel>
                </Grid>

                <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="取消"
                            Command="{Binding CancelCommand}"
                            Style="{StaticResource ButtonDanger}"
                            Margin="0,0,10,0"/>
                    <Button Content="保存"
                            Command="{Binding UpdatePlcDeviceCommand}"
                            Style="{StaticResource ButtonInfo}"/>
                </StackPanel>
                </Grid>
            </Border>
        </Border>
    </Grid>
</UserControl>
