<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <title>ç”Ÿäº§ç›‘æ§çœ‹æ¿</title>
    <link rel="stylesheet" href="css/app.css" />
    <script type="text/javascript" src="js/echarts.min.js"></script>
    <script type="text/javascript" src="js/jdjh.js"></script>
    <script type="text/javascript">
        function getCurDate() {
            var d = new Date();
            var week;
            switch (d.getDay()) {
                case 1:
                    week = "æ˜ŸæœŸä¸€";
                    break;
                case 2:
                    week = "æ˜ŸæœŸäºŒ";
                    break;
                case 3:
                    week = "æ˜ŸæœŸä¸‰";
                    break;
                case 4:
                    week = "æ˜ŸæœŸå››";
                    break;
                case 5:
                    week = "æ˜ŸæœŸäº”";
                    break;
                case 6:
                    week = "æ˜ŸæœŸå…­";
                    break;
                default:
                    week = "æ˜ŸæœŸå¤©";
            }
            var years = d.getFullYear();
            var month = add_zero(d.getMonth() + 1);
            var days = add_zero(d.getDate());
            var hours = add_zero(d.getHours());
            var minutes = add_zero(d.getMinutes());
            var seconds = add_zero(d.getSeconds());
            var ndate = years + "å¹´" + month + "æœˆ" + days + "æ—¥ " + hours + ":"
                + minutes + ":" + seconds + " " + week;
            var divT = document.getElementById("logInfo");
            divT.innerHTML = ndate;
        }
        function add_zero(temp) {
            if (temp < 10)
                return "0" + temp;
            else
                return temp;
        }
        setInterval("getCurDate()", 100);
    </script>
</head>

<body class="bg01">
    <div class="header">
        <h1 class="header-title">ç”Ÿäº§ç›‘æ§çœ‹æ¿</h1>
        <div id="logInfo" style="text-align: left;color: #fff;position: relative;left: 10px;">
            <script type="text/JavaScript" language="JavaScript">
			getCurDate();
		</script>
        </div>
    </div>
    <div class="wrapper">
        <div class="content">
            <div class="col col-l">
                <div class="xpanel-wrapper xpanel-wrapper-55">
                    <div class="xpanel xpanel-l-t">
                        <div class="title">é¡¹ç›®æ¦‚å†µ</div>
                        <div class="bcontent">
                            <ul>
                                <li class="leftrt">å·¥ç¨‹åç§°ï¼š</li>
                                <li class="rightrt">æ–°å»ºå·¥ç¨‹</li>
                                <li class="leftrt">å·¥ç¨‹ç±»å‹ï¼š</li>
                                <li class="rightrt">æ°´ç”µ</li>
                                <li class="leftrt">å·¥ç¨‹çŠ¶æ€ï¼š</li>
                                <li class="rightrt">æ­£åœ¨æ–½å·¥</li>
                                <li class="leftrt">ä¸šä¸»å•ä½ï¼š</li>
                                <li class="rightrt">é¡¹ç›®ç®¡ç†ä¸­å¿ƒ</li>
                                <li class="leftrt">æ–½å·¥å•ä½ï¼š</li>
                                <li class="rightrt">è¾“å˜ç”µåˆ†å…¬å¸</li>
                                <li class="leftrt">å»ºç®¡å•ä½ï¼š</li>
                                <li class="rightrt">å»ºè®¾éƒ¨</li>
                                <li class="leftrt">ç›‘ç†å•ä½ï¼š</li>
                                <li class="rightrt">**ç›‘ç†æœ‰é™å…¬å¸</li>
                                <li class="leftrt">è®¡åˆ’å¼€å§‹æ—¶é—´ï¼š</li>
                                <li class="rightrt">2019-10-21</li>
                                <li class="leftrt">è®¡åˆ’å®Œæˆæ—¶é—´ï¼š</li>
                                <li class="rightrt">2019-10-21</li>
                                <li class="leftrt">å®é™…å¼€å§‹æ—¶é—´ï¼š</li>
                                <li class="rightrt">2019-10-21</li>
                                <li class="leftrt">å®é™…å®Œæˆæ—¶é—´ï¼š</li>
                                <li class="rightrt">2019-10-21</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="xpanel-wrapper xpanel-wrapper-45">
                    <div class="xpanel xpanel-l-b">
                        <div class="title">é¡¹ç›®äººå‘˜å‡ºå‹¤ç‡</div>
                        <div id="ryCharts" class="bcontent">

                        </div>
                    </div>
                </div>
            </div>
            <div class="col col-c">
                <div class="xpanel-wrapper xpanel-wrapper-55">
                    <div class="xpanel xpanel-c-b">
                        <div class="title title-long" style="padding-left:25px">å°æ—¶äº§é‡ä¸è‰¯ç‡ç»Ÿè®¡</div>
                        <div id="container" class="bcontent" style="height:85%;">

                        </div>
                    </div>
                </div>
                <div class="xpanel-wrapper xpanel-wrapper-45">
                    <div class="xpanel xpanel-c-b">
                        <div class="title title-long" style="padding-left:25px">é¡¹ç›®è¿›åº¦ç”˜ç‰¹å›¾</div>
                        <div id="gCharts" class="bcontent" style="height:92%;">

                        </div>
                    </div>

                </div>
            </div>
            <div class="col col-r">
                <div class="xpanel-wrapper xpanel-wrapper-25">
                    <div class="xpanel xpanel-r-t">
                        <div class="title">æœºå…·ç®¡æ§å‡ºå‹¤ç‡</div>
                        <div id="jqCharts" class="bcontent">

                        </div>
                    </div>
                </div>
                <div class="xpanel-wrapper xpanel-wrapper-25">
                    <div class="xpanel xpanel-r-m">
                        <div class="title">è¿ç« æƒ…å†µåˆ†æç‡</div>
                        <div id="wzCharts" class="bcontent">

                        </div>
                    </div>
                </div>
                <div class="xpanel-wrapper xpanel-wrapper-45">
                    <div class="xpanel xpanel-r-b">
                        <div class="title">ç‰©æ–™éªŒæ”¶</div>
                        <div id="wlCharts" class="bcontent">

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">
    // æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
    function formatDateTime(date) {
        if (!date) return '';
        var year = date.getFullYear();
        var month = String(date.getMonth() + 1).padStart(2, '0');
        var day = String(date.getDate()).padStart(2, '0');
        var hours = String(date.getHours()).padStart(2, '0');
        var minutes = String(date.getMinutes()).padStart(2, '0');
        var seconds = String(date.getSeconds()).padStart(2, '0');
        return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
    }

    // è·å–å½“å‰æ—¥æœŸçš„å¼€å§‹å’Œç»“æŸæ—¶é—´
    function getTodayRange() {
        var now = new Date();
        var start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
        var end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
        return { start: start, end: end };
    }

    // è·å–æµ‹è¯•æ—¥æœŸçš„å¼€å§‹å’Œç»“æŸæ—¶é—´ (2026.1.15)
    function getTestRange() {
        var start = new Date(2026, 0, 15, 0, 0, 0);
        var end = new Date(2026, 0, 15, 23, 59, 59);
        return { start: start, end: end };
    }

    // å¤„ç†å°æ—¶äº§é‡æ•°æ® âœ… å¸¦è‰¯ç‡è®¡ç®—
    function processHourlyData(data) {
        if (!data || !Array.isArray(data)) return [];
        return data.map(function (item) {
            if (item.hour === undefined || item.hour === null) {
                console.warn('ç¼ºå¤±Hourå­—æ®µ:', item);
                return null;
            }
            var hour = String(item.hour).padStart(2, '0');
            var totalCount = item.outputQuantity || 0;
            var okCount = item.passQuantity || 0;
            var ngCount = item.failQuantity || 0;
            // å…³é”®ä¿®å¤ï¼šä¿æŒä¸ºæ•°å€¼ï¼Œä¸è¦è½¬å­—ç¬¦ä¸²
            var yieldRate = totalCount === 0 ? 0 : (okCount / totalCount * 100); // â† ä¸è¦ .toFixed()
            return {
                timeLabel: hour + ':00',
                totalCount: totalCount,
                okCount: okCount,
                ngCount: ngCount,
                yieldRate: yieldRate // æ•°å€¼ç±»å‹
            };
        }).filter(Boolean);
    }

    // è·å–å°æ—¶äº§é‡æ•°æ®
    function getHourlyOutput(selectedProductionLine, selectedEquipment, startDate, endDate) {
        var params = new URLSearchParams();
        if (selectedProductionLine) params.append('productionLineId', selectedProductionLine);
        if (selectedEquipment) params.append('resourceId', selectedEquipment);
        if (startDate) params.append('startTime', startDate);
        if (endDate) params.append('endTime', endDate);
        var apiUrl = 'http://localhost:8000/api/Report/HourlyOutput?' + params.toString();
        return fetch(apiUrl, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(function (response) {
                if (!response.ok) throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                return response.json();
            })
            .then(function (data) {
                return data.data || [];
            });
    }

    // åˆå§‹åŒ–å›¾è¡¨æ•°æ®
    var hourlyChartData = [];
    var isTestMode = true;

    // åŠ è½½æ•°æ®å¹¶åˆå§‹åŒ–å›¾è¡¨
    function loadChartData() {
        var dateRange = isTestMode ? getTestRange() : getTodayRange();
        var startDate = formatDateTime(dateRange.start);
        var endDate = formatDateTime(dateRange.end);
        getHourlyOutput('', '', startDate, endDate)
            .then(function (data) {
                hourlyChartData = processHourlyData(data);
                updateChart();
            })
            .catch(function (error) {
                console.error('è·å–å°æ—¶äº§é‡æ•°æ®å¤±è´¥:', error);
                hourlyChartData = [];
                updateChart();
            });
    }

    function updateChart() {
        if (myChart) {
            myChart.setOption({
                xAxis: {
                    data: hourlyChartData.map(item => item.timeLabel)
                },
                series: [
                    {
                        data: hourlyChartData.map(item => item.totalCount)
                        // æŸ±çŠ¶å›¾é¢œè‰²ç”±åˆå§‹ option æ§åˆ¶ï¼Œå¯ä¸å†™
                    },
                    {
                        data: hourlyChartData.map(item => item.yieldRate),
                        // ğŸ‘‡ å¿…é¡»å¸¦ä¸Šè¿™äº›ï¼Œå¦åˆ™æ ·å¼ä¸¢å¤±ï¼
                        lineStyle: { normal: { color: '#FFCC00' } },
                        itemStyle: { normal: { color: '#FFCC00' } },
                        label: { normal: { show: false, color: '#FFCC00' } }
                    }
                ]
            });
        }
    }

    // åˆå§‹åŒ–å°æ—¶äº§é‡ç»Ÿè®¡å›¾è¡¨ âœ… å®Œæ•´ç‰ˆ æŸ±çŠ¶å›¾+é»„è‰²æŠ˜çº¿å›¾+tooltipæ—¶é—´æ®µ+è‰¯ç‡
    var dom = document.getElementById("container");
    var myChart = echarts.init(dom);
    var option = {
        title: { text: 'å°æ—¶äº§é‡ç»Ÿè®¡', show: false },
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: function (params) {
                if (!params || params.length == 0) return "";
                var curTime = params[0].name;
                var hour = parseInt(curTime.split(":")[0]);
                var nextHour = hour + 1 === 24 ? 0 : hour + 1;
                var hourStr = String(hour).padStart(2, '0');
                var nextHourStr = String(nextHour).padStart(2, '0');
                var timePeriod = hourStr + ":00-" + nextHourStr + ":00";

                const curItem = hourlyChartData.find(item => item.timeLabel == curTime);
                var total = curItem ? curItem.totalCount : 0;
                var ok = curItem ? curItem.okCount : 0;
                var ng = curItem ? curItem.ngCount : 0;
                var rate = curItem ? curItem.yieldRate : 0;
                // å¯¹è‰¯ç‡è¿›è¡Œæ ¼å¼åŒ–ï¼Œæ˜¾ç¤ºä¸€ä½å°æ•°
                var formattedRate = rate.toFixed(1);

                var res = 'æ—¶é—´æ®µï¼š' + timePeriod;
                res += '<br/>æ€»äº§é‡: ' + total;
                res += '<br/>åˆæ ¼æ•°é‡: ' + ok;
                res += '<br/>ä¸åˆæ ¼æ•°é‡: ' + ng;
                res += '<br/>è‰¯ç‡: ' + formattedRate + '%';
                return res;
            }
        },
        xAxis: {
            type: 'category',
            data: [],
            axisLabel: { color: '#1890ff', fontSize: 12 },
            axisLine: { lineStyle: { color: '#1890ff' } },
            splitLine: { show: false }
        },
        yAxis: [
            {
                type: 'value',
                name: 'äº§å“æ•°é‡',
                nameTextStyle: { color: '#1890ff', fontSize: 12, fontWeight: 'bold' },
                axisLabel: { color: '#1890ff', fontSize: 12 },
                axisLine: { lineStyle: { color: '#1890ff' } },
                splitLine: { lineStyle: { color: 'rgba(24,144,255,0.1)' } },
                min: 0
            },
            {
                type: 'value',
                name: 'è‰¯ç‡(%)',
                nameTextStyle: { color: '#FFCC00', fontSize: 12, fontWeight: 'bold' },
                axisLabel: { color: '#FFCC00', fontSize: 12, formatter: '{value} %' },
                axisLine: { lineStyle: { color: '#FFCC00' } },
                splitLine: { show: false },
                min: 0,
                max: 100,
                position: 'right'
            }
        ],
        series: [
            {
                name: 'æ€»äº§é‡',
                type: 'bar',
                yAxisIndex: 0,
                data: [],
                itemStyle: {
                    normal: {
                        color: '#1890ff',
                        borderRadius: [10, 10, 0, 0]
                    }
                },
                label: {
                    normal: {
                        show: true,
                        position: 'top',
                        color: '#1890ff',
                        fontSize: 12,
                        fontWeight: 'bold'
                    }
                },
                animation: true,
                animationDuration: 1000
            },
            {
                name: 'è‰¯ç‡',
                type: 'line',
                yAxisIndex: 1,
                data: [],
                symbol: 'circle',
                symbolSize: 6,
                smooth: true,
                // ğŸ‘‡ å…³é”®ä¿®æ”¹ï¼šåŒ…è£¹åœ¨ normal ä¸­
                lineStyle: {
                    normal: {
                        color: '#FFCC00',
                        width: 2
                    }
                },
                itemStyle: {
                    normal: {
                        color: '#FFCC00'
                    }
                },
                label: {
                    normal: {
                        show: false,
                        position: 'top',
                        color: '#FFCC00',
                        fontSize: 10
                    }
                },
                animation: true,
                animationDuration: 1000
            }
        ]
    };

    if (option && typeof option === "object") {
        myChart.setOption(option, true);
    }

    // åŠ è½½æ•°æ®
    loadChartData();

    //ç”˜ç‰¹å›¾ âœ… ä¿®å¤æœªå®šä¹‰æŠ¥é”™
    var gdom = document.getElementById("gCharts");
    var gCharts = echarts.init(gdom);
    var ptoption = {};
    if (ptoption && typeof ptoption === "object") {
        gCharts.setOption(ptoption, true);
    }

    //äººå‘˜å‡ºå‹¤ç‡ âœ… å”¯ä¸€ç‰ˆæœ¬ï¼Œæ— é‡å¤
    var rydom = document.getElementById("ryCharts");
    var ryCharts = echarts.init(rydom);
    ryoption = {
        title: { text: 'é¡¹ç›®å‡ºå‹¤ç‡', subtext: 'æ¨¡æ‹Ÿæ•°æ®', x: 'center', y: 'top', itemGap: 30, backgroundColor: '#EEE', textStyle: { fontSize: 26, fontWeight: 'bolder', color: '#000080' }, subtextStyle: { fontSize: 18, color: '#8B2323' }, show: false },
        tooltip: { trigger: 'item', formatter: "{a} <br/>{b} : {c} ({d}%)" },
        legend: { orient: 'vertical', x: 'left', y: 'top', itemWidth: 24, itemHeight: 18, textStyle: { color: '#5dc2fe' }, itemGap: 15, data: ['å®åˆ°', 'æœªåˆ°', 'è¿Ÿåˆ°'] },
        calculable: true,
        color: ['#3CB371', '#bda29a', '#8B0000'],
        series: [{
            name: 'æ¯æ—¥å‡ºå‹¤ç‡',
            type: 'pie',
            radius: ['30%', '60%'],
            center: ['60%', '35%'],
            data: [{ value: 150, name: 'å®åˆ°' }, { value: 50, name: 'æœªåˆ°' }, { value: 5, name: 'è¿Ÿåˆ°' }],
            itemStyle: { emphasis: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(30, 144, 255ï¼Œ0.5)' } },
            labelLine: { normal: { show: false } },
            label: { normal: { position: 'inner', formatter: '{c}' } }
        }]
    };
    if (ryoption && typeof ryoption === "object") {
        ryCharts.setOption(ryoption, true);
    }

    //æœºå™¨å‡ºå‹¤ç‡
    var jqdom = document.getElementById("jqCharts");
    var jqCharts = echarts.init(jqdom);
    jqoption = {
        title: { text: 'æœºå…·çŠ¶æ€åˆ†æ', show: false },
        tooltip: { trigger: 'item', formatter: "{a} <br/>{b} : {c} ({d}%)" },
        legend: { orient: 'vertical', x: 'left', y: 'top', itemWidth: 24, itemHeight: 18, textStyle: { color: '#5dc2fe' }, itemGap: 15, data: ['æ­£å¸¸è¿è¡Œ', 'æ—¥å¸¸æ£€ä¿®', 'æ•…éšœåœæ­¢'] },
        calculable: true,
        color: ['#3CB371', '#FF9F7F', '#8B0000'],
        series: [{
            name: 'æœºå…·çŠ¶æ€åˆ†æ',
            type: 'pie',
            radius: ['30%', '60%'],
            center: ['60%', '35%'],
            data: [{ value: 10, name: 'æ­£å¸¸è¿è¡Œ' }, { value: 5, name: 'æ—¥å¸¸æ£€ä¿®' }, { value: 2, name: 'æ•…éšœåœæ­¢' }],
            itemStyle: { emphasis: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(30, 144, 255ï¼Œ0.5)' } },
            labelLine: { normal: { show: false } },
            label: { normal: { position: 'inner', formatter: '{c}' } }
        }]
    };
    if (jqoption && typeof jqoption === "object") {
        jqCharts.setOption(jqoption, true);
    }

    //è¿ç« é”™è¯¯ç‡
    var wzdom = document.getElementById("wzCharts");
    var wzCharts = echarts.init(wzdom);
    wzoption = {
        title: { text: 'è¿ç« é”™è¯¯ç‡', show: false },
        tooltip: { trigger: 'item', formatter: "{a} <br/>{b} : {c} ({d}%)" },
        legend: { orient: 'vertical', x: 'left', y: 'top', itemWidth: 24, itemHeight: 18, textStyle: { color: '#5dc2fe' }, itemGap: 15, data: ['è­¦å‘Š', 'ä¸€èˆ¬è¿ç« ', 'é‡å¤§è¿ç« '] },
        calculable: true,
        color: ['#00CCFF', '#CC6600', '#8B0000'],
        series: [{
            name: 'æœºå…·çŠ¶æ€åˆ†æ',
            type: 'pie',
            radius: ['30%', '60%'],
            center: ['60%', '35%'],
            data: [{ value: 20, name: 'è­¦å‘Š' }, { value: 10, name: 'ä¸€èˆ¬è¿ç« ' }, { value: 2, name: 'é‡å¤§è¿ç« ' }],
            itemStyle: { emphasis: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(30, 144, 255ï¼Œ0.5)' } },
            labelLine: { normal: { show: false } },
            label: { normal: { position: 'inner', formatter: '{c}' } }
        }]
    };
    if (wzoption && typeof wzoption === "object") {
        wzCharts.setOption(wzoption, true);
    }

    //ç‰©æ–™éªŒæ”¶
    var wldom = document.getElementById("wlCharts");
    var wlCharts = echarts.init(wldom);
    wloption = {
        title: { text: 'ç‰©æ–™åˆ°è´§æƒ…å†µåˆ†æ', subtext: 'çº¯å±è™šæ„', show: false },
        color: ['#00CCFF', '#CC6600', '#8B0000'],
        tooltip: { trigger: 'axis' },
        legend: { orient: 'horizontal', data: ['è®¡åˆ’é‡‡è´­é‡', 'å®é™…åˆ°è´§é‡'], x: 'center', y: 'top', textStyle: { color: '#5dc2fe' } },
        calculable: true,
        xAxis: [{
            type: 'category',
            data: ['é‡‡è´­è®¡åˆ’å£¹', 'é‡‡è´­è®¡åˆ’è´°', 'é‡‡è´­è®¡åˆ’å'],
            axisLine: { lineStyle: { color: "#5dc2fe" } },
            splitLine: { show: false }
        }],
        yAxis: [{
            type: 'value',
            axisLine: { lineStyle: { color: "#5dc2fe" } },
            splitLine: { show: false }
        }],
        series: [{ name: 'è®¡åˆ’é‡‡è´­é‡', type: 'bar', data: [10, 15, 20] }, { name: 'å®é™…åˆ°è´§é‡', type: 'bar', data: [5, 8, 12] }]
    };
    if (wloption && typeof wloption === "object") {
        wlCharts.setOption(wloption, true);
    }

    //çª—å£è‡ªé€‚åº”
    window.onresize = function () {
        myChart.resize();
        gCharts.resize();
        ryCharts.resize();
        jqCharts.resize();
        wzCharts.resize();
        wlCharts.resize();
    }

</script>

</html>