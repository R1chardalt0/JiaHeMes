# 软件详细设计文档（完善版）
# 1 引言
## 1.1 编写目的
### 目标读者
本文档面向项目开发团队以及项目管理团队，为相关人员提供系统实现的详细技术指导。

### 文档用途
1. **指导开发实现**：提供系统编码、模块集成的技术依据，确保各模块实现符合设计规范和业务需求；
2. **测试验收依据**：提供系统功能、性能、接口等测试的设计基准，确保测试工作覆盖完整的系统功能点；
3. **运维部署参考**：提供系统部署、配置、监控的技术文档，保障系统稳定运行；

### 文档范围
本文档详细描述嘉和MES管理系统的系统架构、功能模块、数据库设计、接口设计等内容，覆盖系统从开发到部署的全生命周期技术实现细节，但不包含项目管理计划、商业需求分析等非技术实现内容。

## 1.2 项目背景
### 项目来源
本项目为嘉和生产线数字化转型的核心支撑系统，提出制造执行系统（MES）建设需求。

### 业务场景
本系统应用于嘉和生产线，覆盖从原材料投入、组装、测试、包装到成品入库的全生产流程。主要业务场景包括：
1. **生产计划管理**：接收ERP系统下发的生产订单，分解为可执行的车间生产计划；
2. **实时数据采集**：通过与生产设备对接，实时采集生产过程中的关键参数（如电压、电流、温度等）；
3. **生产调度监控**：可视化展示生产线运行状态，支持生产异常预警与快速响应；
4. **质量追溯管理**：建立从原材料到成品的全生命周期追溯体系；
5. **设备管理维护**：记录设备运行数据，支持预防性维护与故障分析。

### 核心价值
1. **提升生产效率**：通过自动化数据采集与智能调度，减少人工干预，提高生产线运行效率；
2. **保证产品质量**：实时监控生产过程参数，及时发现质量异常，降低不良品率；
3. **实现数字化管理**：建立完整的生产数据体系，为管理层决策提供数据支撑；
4. **增强合规能力**：满足客户对产品质量追溯的要求，提升企业市场竞争力；
5. **降低运营成本**：通过设备预防性维护，减少设备故障停机时间，降低生产成本。

## 1.3 参考材料
列出需求规格说明书、接口规范、技术标准等引用文档。

# 2 系统总体设计
## 2.1 整体架构
### 2.1.1 架构模式
本系统采用前后端分离架构模式，实现了前端展示与后端业务逻辑的解耦，支持多客户端接入与独立部署。

### 2.1.2 前端架构
- **核心框架**：React 19.1.0 + TypeScript 5.6.3
- **解决方案**：Ant Design Pro 6.0.0 + Umi Max 4.3.24
- **主要模块**：
  - 仪表盘（dashboard）：生产状态实时监控
  - 设备管理（device）：设备信息与运行状态管理
  - 系统管理（systems）：用户、权限、配置管理
  - 追溯管理（Trace）：产品全生命周期追溯
  - 历史记录（History）：生产历史数据查询
  - 生产设备管理（productionEquipment）：设备详细信息与维护记录

### 2.1.3 后端架构
- **核心框架**：.NET 8.0 + ASP.NET Core Web API
- **分层设计**：
  - 应用层（Application）：业务逻辑实现
  - 服务层（Service）：核心业务服务
  - 数据访问层（DbContexts）：数据库操作
  - 实体层（Entitys）：数据模型定义
  - 通用工具层（Common）：公共组件与工具
- **主要模块**：
  - 追溯模块（Trace）：产品追溯业务逻辑
  - 系统管理模块（Systems）：基础系统功能
  - Web API：对外接口提供
  - WPF客户端（Client）：设备管理桌面应用

### 2.1.4 部署拓扑
客户端 → Web API → 应用服务层 → 数据访问层 → PostgreSQL数据库

### 2.1.5 架构特点
- 模块化设计：业务逻辑按功能模块清晰划分
- 领域驱动设计风格：实体定义与业务逻辑分离
- 多客户端支持：Web客户端 + WPF桌面客户端
- 前后端松耦合：通过API接口实现数据交互
## 2.2 整体功能架构
### 2.2.1 核心功能模块
1. **生产管理模块**
   - 物料上传管理：原材料批次上传与记录（FeedMaterial）
   - 返工管理：不合格品返工流程处理（ReWork）
   - 跳站管理：生产工序跳站流程处理（JumpStation）

2. **设备管理模块**
   - 产线管理：生产线信息维护与管理（productionEquipment/productionLine）
   - 设备管理：生产设备信息维护与管理（productionEquipment/equipment）
   - 设备监控：生产设备运行状态实时监控（device/monitor）

3. **追溯管理模块**
   - SN表追溯：产品序列号追溯查询（Trace/MesSnListTrace）
   - 生产记录：生产过程数据记录与查询（Trace/ProductionRecords）
   - 产品追溯信息：产品全生命周期追溯详情（Trace/ProductTraceInfo）
   - 设备追溯信息：设备使用历史追溯（Trace/DeviceTraceInfo）

4. **基础设施模块**
   - BOM管理：物料清单维护与管理（infrastructure/Bom）
   - 工艺路线：生产工艺路线定义与管理（infrastructure/ProcessRoute）
   - 产品列表：产品信息维护与管理（infrastructure/ProductList）
   - 工单管理：生产工单创建与管理（infrastructure/WorkOrderManagement）
   - 订单列表：生产订单信息管理（infrastructure/OrderList）
   - 工位列表：生产工位信息维护（infrastructure/StationList）

5. **系统管理模块**
   - 用户管理：用户信息与权限分配（systems/user）
   - 角色管理：角色定义与权限配置（systems/role）
   - 菜单管理：系统菜单配置与管理（systems/menu）
   - 部门管理：组织机构与部门管理（systems/dept）
   - 职位管理：职位信息与权限配置（systems/position）
   - 操作日志：系统操作日志记录与查询（systems/operateLog）

6. **数据查询与分析模块**
   - 仪表盘：生产数据可视化展示（dashboard/analysis）
   - 历史记录：生产历史数据查询（History/DeviceTraceInfo, History/ProductTraceInfo）
   - 报表：生产报表生成与查询（Report/TraceSN）

7. **AI助手模块**
   - 豆包AI：AI辅助查询与分析（doubao-chat）

### 2.2.2 功能架构特点
- 业务逻辑清晰：按生产制造核心业务流程划分模块
- 数据关联性强：各模块间通过统一数据模型实现信息共享
- 扩展性良好：支持新增功能模块与业务流程

## 2.3 整体技术架构
### 2.3.1 前端技术栈
- **核心框架**：React 19.1.0 + TypeScript 5.6.3
- **企业级解决方案**：Ant Design Pro 6.0.0 + Umi Max 4.3.24
- **UI组件库**：Ant Design 5.26.4
- **专业组件**：@ant-design/pro-components 2.8.9
- **图表库**：@ant-design/charts 2.6.2、@ant-design/plots 2.6.3
- **工具库**：
  - dayjs 1.11.13（日期处理）
  - xlsx 0.18.5（Excel文件处理）
  - classnames 2.5.1（CSS类名管理）
  - swagger-ui-dist 5.27.1（API文档）

### 2.3.2 后端技术栈
- **核心框架**：.NET 8.0 + C#
- **Web API**：ASP.NET Core
- **ORM**：Entity Framework Core
- **任务调度**：Quartz 3.8.1
- **身份验证**：JWT（JSON Web Token）
- **架构模式**：
  - 分层架构（Application/Service/DbContexts/Entitys/Common）
  - 仓库模式（Repository Pattern）
  - 依赖注入

### 2.3.3 数据库
- **主数据库**：PostgreSQL

### 2.3.4 其他技术
- **AI集成**：豆包AI
- **桌面应用**：WPF（MVVM模式）
- **国际化**：支持多语言（zh-CN、en-US、ja-JP等）

## 2.4 设计目标
### 2.4.1 性能目标
- **响应时间**：
  - 普通查询响应时间 ≤1s（95%场景）
  - 复杂聚合查询响应时间 ≤2s（95%场景）
  - 设备数据实时上报延迟 ≤100ms
- **数据处理能力**：支持单表≥1000万条记录的高效查询

### 2.4.2 功能目标
- **完整的生产流程覆盖**：从原材料投入到成品出库的全流程管理
- **精准的产品追溯**：实现从原材料到成品的双向追溯
- **实时的生产监控**：生产线状态与设备参数实时可视化
- **智能的数据分析**：生产效率与质量指标多维度分析

### 2.4.3 技术目标
- **高可靠性**：系统可用性≥99.9%
- **可扩展性**：支持业务功能与用户规模的平滑扩展
- **可维护性**：模块化设计，便于系统维护与升级
- **安全性**：数据传输加密，权限控制严格

### 2.4.4 合规目标
- 符合ISO9001质量管理体系要求
- 满足客户对产品追溯的合规要求
## 2.5 设计原则
### 2.5.1 总体原则
业务逻辑下沉至后端，前端仅负责展示与交互
所有敏感操作需鉴权
### 2.5.2 实用性与先进性
采用成熟技术栈，避免过度设计
### 2.5.3 标准化、开放性、兼容性
RESTful API，JSON 格式，遵循 OpenAPI 3.0 规范
### 2.5.4 高可靠性与稳定性
关键接口幂等设计，异常自动重试机制（如消息队列）
### 2.5.5 易用性
接口语义清晰，错误码统一
### 2.5.6 灵活性与可扩展性
模块解耦，支持插件式扩展（如新增数据源）
### 2.5.7 经济性与投资保护
利用现有基础设施，避免重复采购

# 3 系统功能模块详细设计
## 3.1 生产管理
### 3.1.1 上料


## 3.2 基础设施



# 4 性能设计

# 5 数据库设计


# 6 接口设计（RESTful）
每个接口包含：URL、Method、请求/响应结构、错误码

## 6.1 生产管理
生产管理模块包含上料、跳站、返工等核心生产操作接口，用于控制和管理生产过程。

### 6.1.1 生产管理接口列表

| 接口名称 | 接口路径 | 请求方法 | 功能描述 | 权限要求 |
|--------|---------|---------|---------|---------|
| 物料上传接口 | `/api/CommonInterfase/FeedMaterial` | POST | 记录原材料批次的上料信息，实现物料批次与生产工单的关联 | 生产管理员/操作员 |
| 跳站接口 | `/api/CommonInterfase/JumpStation` | POST | 处理生产过程中的跳站操作，将产品从当前站点跳过到指定站点 | 生产管理员/操作员 |
| 返工接口 | `/api/CommonInterfase/ReWork` | POST | 处理生产过程中的返工操作，将产品从当前站点返回到指定站点 | 生产管理员/操作员 |

### 6.1.2 核心接口说明

#### 6.1.2.1 物料上传接口
- **业务逻辑**：
  - 接收前端提交的物料批次信息，包括批次号、设备编码、站点编码、工单编码、上料数量和产品编码
  - 验证设备是否存在且已绑定生产工单
  - 验证产品是否存在于系统中
  - 验证站点是否存在于系统中
  - 验证批次号是否符合BOM定义的规则（正则表达式）
  - 验证批次号是否已被使用
  - 验证批次号中提取的物料是否与请求的产品编码一致
  - 验证上料数量是否大于0
  - 如果BOM定义了保质期，自动计算批次过期时间
  - 将物料批次信息与生产工单关联并保存到数据库
  - 返回上料成功消息

#### 6.1.2.2 跳站接口
- **业务逻辑**：
  - 接收前端提交的产品序列号和目标跳站站点编码
  - 验证产品序列号是否存在于Current表中
  - 验证当前站点和跳站站点是否存在
  - 验证当前站点是否与跳站站点相同
  - 验证工单是否存在
  - 验证当前站点和跳站站点是否在工艺路线中存在
  - 验证当前站点顺序是否小于跳站站点顺序（确保跳站方向正确）
  - 更新产品的当前站点信息为跳站站点
  - 记录跳站操作日志
  - 返回跳站成功消息

#### 6.1.2.3 返工接口
- **业务逻辑**：
  - 接收前端提交的产品序列号、目标返工站点编码和可选的物料批次明细ID列表
  - 验证产品序列号是否存在于Current表中
  - 验证当前站点和返工站点是否存在
  - 验证当前站点是否与返工站点相同
  - 验证工单是否存在
  - 验证当前站点和返工站点是否在工艺路线中存在
  - 验证当前站点顺序是否大于返工站点顺序（确保返工方向正确）
  - 如果提供了解绑物料列表，解绑相应的物料批次
  - 更新产品的当前站点信息为返工站点
  - 记录返工操作日志
  - 返回返工成功消息

## 6.2 工单管理
工单管理模块提供了工单的增删改查、状态更新和统计等功能，支持生产工单和返工工单的全生命周期管理。

### 6.2.1 工单管理接口列表

| 接口名称 | 接口路径 | 请求方法 | 功能描述 | 权限要求 |
|--------|---------|---------|---------|---------|
| 分页查询工单列表接口 | `/api/OrderList/GetOrderListList` | GET | 查询工单列表，支持多种条件过滤和分页 | 生产管理员/操作员 |
| 根据ID获取工单详情接口 | `/api/OrderList/GetOrderListById` | GET | 根据工单ID获取工单的详细信息 | 生产管理员/操作员 |
| 根据工单编码获取工单详情接口 | `/api/OrderList/GetOrderListByCode` | GET | 根据工单编码获取工单的详细信息 | 生产管理员/操作员 |
| 创建工单接口 | `/api/OrderList/CreateOrderList` | POST | 创建新的工单 | 生产管理员 |
| 更新工单接口 | `/api/OrderList/UpdateOrderListById` | POST | 更新工单的信息 | 生产管理员 |
| 删除工单接口 | `/api/OrderList/DeleteOrderListByIds` | POST | 删除工单，支持单个删除和批量删除 | 生产管理员 |
| 更新工单状态接口 | `/api/OrderList/UpdateOrderStatus` | POST | 更新工单的状态 | 生产管理员/操作员 |
| 获取工单统计信息接口 | `/api/OrderList/GetOrderStatistics` | GET | 获取工单的统计信息，如各状态工单的数量 | 生产管理员/操作员 |

### 6.2.2 核心接口说明

#### 6.2.2.1 分页查询工单列表接口
- **业务逻辑**：
  - 接收前端提交的查询参数，包括工单ID、工单编码、工单名称、产品ID等过滤条件和分页参数
  - 验证分页参数（PageIndex ≥ 1，PageSize 1-100）
  - 根据过滤条件构建数据库查询
  - 执行分页查询获取工单列表
  - 封装查询结果并返回

#### 6.2.2.2 根据ID获取工单详情接口
- **业务逻辑**：
  - 接收前端提交的工单ID参数
  - 验证工单ID是否为有效的GUID格式
  - 根据工单ID从数据库中查询工单详情
  - 返回查询到的工单信息

#### 6.2.2.3 根据工单编码获取工单详情接口
- **业务逻辑**：
  - 接收前端提交的工单编码参数
  - 验证工单编码是否为空
  - 根据工单编码从数据库中查询工单详情
  - 返回查询到的工单信息

#### 6.2.2.4 创建工单接口
- **业务逻辑**：
  - 接收前端提交的工单创建信息，包括工单编码、工单名称、产品ID等
  - 验证必填参数（工单编码、工单名称、产品ID）是否为空
  - 验证工单编码是否已存在
  - 创建新的工单记录
  - 返回创建成功的工单信息

#### 6.2.2.5 更新工单接口
- **业务逻辑**：
  - 接收前端提交的工单ID和更新信息
  - 验证URL中的ID与请求体中的ID是否匹配
  - 验证必填参数是否为空
  - 查询工单是否存在
  - 更新工单信息
  - 返回更新后的工单信息

#### 6.2.2.6 删除工单接口
- **业务逻辑**：
  - 接收前端提交的工单ID列表
  - 验证ID列表是否为空
  - 查询所有要删除的工单是否存在
  - 删除对应的工单记录
  - 返回删除结果

#### 6.2.2.7 更新工单状态接口
- **业务逻辑**：
  - 接收前端提交的工单ID和新状态
  - 验证工单ID和新状态是否为空
  - 验证新状态是否为有效的状态值
  - 查询工单是否存在
  - 更新工单状态
  - 返回更新后的工单信息

#### 6.2.2.8 获取工单统计信息接口
- **业务逻辑**：
  - 接收前端请求
  - 统计各状态工单的数量
  - 返回统计结果

# 7 系统出错处理设计
## 7.1 出错信息
返回结构：{ code, message, traceId }
日志记录：关键操作、异常堆栈
## 7.2 补救措施
重试机制（如网络超时）
数据回滚（事务保证）
## 7.3 系统维护设计
健康检查接口 /health
日志集中采集（如 ELK）
# 8 系统处理规定
## 8.1 输入输出要求
所有时间格式：ISO 8601（如 "2026-01-19T10:00:00Z"）
数值精度：保留2位小数（如金额）
## 8.2 数据管理能力要求
单表支持 ≥ 1000 万条记录（通过索引优化）
## 8.3 故障处理要求
数据库主从切换 ≤ 30s
服务无单点故障
## 8.4 其他专门要求
审计日志：记录关键数据变更（谁、何时、改了什么）
附录（可选）
A. 术语表
B. 接口错误码清单
C. 数据库ER图（或表结构DDL）